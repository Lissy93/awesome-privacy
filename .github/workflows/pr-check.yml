name: PR Check

on:
  pull_request:
    branches: [main]
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      yaml_changed: ${{ steps.changes.outputs.yaml_changed }}
      non_yaml_changed: ${{ steps.changes.outputs.non_yaml_changed }}
    steps:
      - uses: actions/checkout@v4
      - run: git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Detect changed files
        id: changes
        run: python lib/checks/detect-changes.py --base-ref ${{ github.event.pull_request.base.sha }}
      - name: Non-YAML changes warning
        if: steps.changes.outputs.non_yaml_changed == 'true'
        run: python lib/checks/warn-non-yaml.py --base-ref ${{ github.event.pull_request.base.sha }}

  pr-meta:
    name: PR metadata
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Check PR metadata
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_DRAFT: ${{ github.event.pull_request.draft }}
        run: python lib/checks/check-pr-meta.py
      - name: Upload findings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: findings-meta
          path: /tmp/findings-meta.json
          if-no-files-found: ignore

  file-checks:
    name: File checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Check for direct README edits
        run: python lib/checks/check-readme-edits.py --base-ref ${{ github.event.pull_request.base.sha }}

  data-validation:
    name: Data validation
    needs: detect-changes
    if: needs.detect-changes.outputs.yaml_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q -r lib/requirements.txt
      - name: Schema validation
        id: schema
        continue-on-error: true
        run: make validate
      - name: YAML diff
        id: diff
        continue-on-error: true
        run: python lib/checks/check-yaml-diff.py --base-ref ${{ github.event.pull_request.base.sha }}
      - name: Check additions
        env:
          SCHEMA_OUTCOME: ${{ steps.schema.outcome }}
        run: python lib/checks/check-additions.py
      - name: Upload diff data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-diff
          path: /tmp/pr-diff.json
          if-no-files-found: ignore
      - name: Upload findings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: findings-data
          path: /tmp/findings-data.json
          if-no-files-found: ignore
      - name: Fail if critical checks failed
        if: steps.schema.outcome == 'failure' || steps.diff.outcome == 'failure'
        run: exit 1

  project-checks:
    name: Project checks
    needs: data-validation
    if: "!cancelled() && needs.data-validation.result != 'skipped'"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q -r lib/requirements.txt
      - name: Download diff data
        uses: actions/download-artifact@v4
        with:
          name: pr-diff
          path: /tmp
        continue-on-error: true
      - name: Check project health
        env:
          PR_USER: ${{ github.event.pull_request.user.login }}
          GITHUB_TOKEN: ${{ github.token }}
        run: python lib/checks/check-project.py
      - name: Upload findings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: findings-project
          path: /tmp/findings-project.json
          if-no-files-found: ignore

  summary:
    name: Summary
    if: always()
    needs: [detect-changes, pr-meta, file-checks, data-validation, project-checks]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Download all findings
        uses: actions/download-artifact@v4
        with:
          pattern: findings-*
          path: /tmp/artifacts
          merge-multiple: true
        continue-on-error: true
      - name: Format comment
        env:
          PR_USER: ${{ github.event.pull_request.user.login }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RUN_ID: ${{ github.run_id }}
          README_FAILED: ${{ needs.file-checks.result == 'failure' && 'true' || 'false' }}
        run: python lib/checks/format-comment.py
      - name: Upload PR metadata
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-meta
          path: /tmp/pr-meta/
