name: PR Check

on:
  pull_request:
    branches: [main]
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      yaml_changed: ${{ steps.changes.outputs.yaml_changed }}
      non_yaml_changed: ${{ steps.changes.outputs.non_yaml_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q -r lib/requirements.txt
      - name: Detect changed files
        id: changes
        run: python lib/checks/detect-changes.py --base-ref ${{ github.event.pull_request.base.sha }}
      - name: Non-YAML changes warning
        if: steps.changes.outputs.non_yaml_changed == 'true'
        run: python lib/checks/warn-non-yaml.py --base-ref ${{ github.event.pull_request.base.sha }}

  readme:
    name: README edits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q -r lib/requirements.txt
      - name: Check for direct README edits
        run: python lib/checks/check-readme-edits.py --base-ref ${{ github.event.pull_request.base.sha }}

  schema:
    name: Schema validation
    needs: detect-changes
    if: needs.detect-changes.outputs.yaml_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q -r lib/requirements.txt
      - name: Validate schema
        run: make validate

  diff:
    name: Single-entry rule
    needs: detect-changes
    if: needs.detect-changes.outputs.yaml_changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_service_changes: ${{ steps.diff.outputs.has_service_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q -r lib/requirements.txt
      - name: YAML diff analysis
        id: diff
        run: python lib/checks/check-yaml-diff.py --base-ref ${{ github.event.pull_request.base.sha }}
      - name: Upload diff data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-diff
          path: /tmp/pr-diff.json
          if-no-files-found: ignore

  links:
    name: Link validation
    needs: diff
    if: needs.diff.result == 'success' && needs.diff.outputs.has_service_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q -r lib/requirements.txt
      - name: Download diff data
        uses: actions/download-artifact@v4
        with:
          name: pr-diff
          path: /tmp
      - name: Validate links
        run: python lib/checks/check-links.py --diff-json /tmp/pr-diff.json

  template:
    name: PR template
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q -r lib/requirements.txt
      - name: PR template check
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: python lib/checks/check-template.py

  comment:
    name: Summary
    if: always()
    needs: [readme, schema, diff, links, template]
    runs-on: ubuntu-latest
    steps:
      - name: Save PR metadata
        run: |
          mkdir -p /tmp/pr-meta
          echo "${{ github.event.pull_request.number }}" > /tmp/pr-meta/number.txt
          echo "${{ github.run_id }}" > /tmp/pr-meta/run-id.txt

      - name: Build failure comment
        if: contains(needs.*.result, 'failure')
        run: |
          cat > /tmp/pr-meta/comment.md << 'HEADER'
          <!-- pr-check-bot -->
          > [!CAUTION]
          > ## PR check failed
          HEADER

          if [ "${{ needs.readme.result }}" = "failure" ]; then
          cat >> /tmp/pr-meta/comment.md << 'EOF'

          ### Direct README edits
          The auto-generated section of the README must not be edited directly.
          Please make your changes in `awesome-privacy.yml` instead â€” the README is regenerated from it.
          EOF
          fi

          if [ "${{ needs.schema.result }}" = "failure" ]; then
          cat >> /tmp/pr-meta/comment.md << 'EOF'

          ### Schema validation failed
          `awesome-privacy.yml` does not conform to the expected schema.
          Please check your YAML against the structure defined in `lib/schema.json`.
          EOF
          fi

          if [ "${{ needs.diff.result }}" = "failure" ]; then
          cat >> /tmp/pr-meta/comment.md << 'EOF'

          ### Single-entry rule
          Each PR should add, modify, or remove only **one** service at a time.
          If you need to change multiple services, please split them into separate PRs.
          EOF
          fi

          if [ "${{ needs.links.result }}" = "failure" ]; then
          cat >> /tmp/pr-meta/comment.md << 'EOF'

          ### Link validation failed
          One or more URLs in your entry could not be verified.
          Please ensure all links are correct and accessible.
          EOF
          fi

          if [ "${{ needs.template.result }}" = "failure" ]; then
          cat >> /tmp/pr-meta/comment.md << 'EOF'

          ### PR template incomplete
          Your PR description is missing required sections.
          Please fill out the **Type**, **Changes**, and **Checklist** sections of the PR template.
          EOF
          fi

          printf '\n---\n*See the [workflow logs](%s/%s/actions/runs/%s) for full details.*\n' \
            "${{ github.server_url }}" "${{ github.repository }}" "${{ github.run_id }}" \
            >> /tmp/pr-meta/comment.md

      - name: Upload PR metadata
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-meta
          path: /tmp/pr-meta/
